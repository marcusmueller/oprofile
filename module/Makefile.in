# $Id: Makefile.in,v 1.6 2002/01/10 03:47:13 phil_e Exp $

BKCFLAGS=@BKCFLAGS@ @MODVERSIONS@
MODINSTALLDIR=@MODINSTALLDIR@/oprofile

# ugly: in 2.2 only one object file must be compiled with module version,
# NO_MODULE_VERSION expand to __NO_VERSION__ in this case, this work
# because only one module is compiled with BKCFLAGS. If you compile more
# than one module with BKCFLAGS you break 2.2 compatibility. FIXME another way?
BKCFLAGS += -pipe -D__KERNEL__ -DMODULE -Wall -Wstrict-prototypes -Wunused -O2 -fomit-frame-pointer -fno-strict-aliasing
KCFLAGS := $(BKCFLAGS) -march=i686 @NO_MODULE_VERSION@
ASMFLAGS := -D__ASSEMBLY__ -DMODULE -D__KERNEL__ -traditional

.PHONY: all install clean uninstall

all: oprofile.o

install: all
	-$(MKDIR_P) $(MODINSTALLDIR)
	cp oprofile.o $(MODINSTALLDIR)
	depmod -a

uninstall:
	-rm -f $(MODINSTALLDIR)/oprofile.o
	-rmdir --ignore-fail-on-non-empty  $(MODINSTALLDIR)
	depmod -a

clean:
	rm -rf *.o .deps

oprofile.o: op_init.o op_util.o oprofile_c.o oprofile_nmi.o op_syscalls.o op_events_module.o op_x86.o
	$(LD) -r -o $@ $^

# we can't use implicit rules for this directory

op_init.o: op_init.c
	$(CC) $(BKCFLAGS) -c -o $@ $<

op_util.o: op_util.c
	$(CC) $(KCFLAGS) -c -o $@ $<

# can't use auto deps here
oprofile_c.o: oprofile.c oprofile.h ../op_user.h
	$(CC) $(KCFLAGS) -c -o $@ $<

op_x86.o: op_x86.c
	$(CC) $(KCFLAGS) -c -o $@ $<

op_syscalls.o: op_syscalls.c
	$(CC) $(KCFLAGS) -c -o $@ $<

oprofile.s: oprofile.c
	$(CC) $(KCFLAGS) -S $<

# can't use auto deps here
op_events_module.o: ../events/op_events.c ../op_user.h
	$(CC) $(KCFLAGS) -c -o $@ $<

oprofile_nmi.o: oprofile_nmi.S
	$(CC) $(ASMFLAGS) -c -o $@ $<

# not all object files can use auto deps in this directory
ALL_SOURCES = op_init.c op_util.c op_x86.c op_syscall.c

include ../Rules.make

# we must overwrite dependencies make flags, the default can't work
CPPFLAGS_DEPS += $(BKCFLAGS)
